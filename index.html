<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نظام النقل المدرسي – Supabase + تسجيل الدخول</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0f172a; --card:#0b1220; --muted:#94a3b8; --text:#e2e8f0; --accent:#22c55e; --accent2:#38bdf8; --danger:#ef4444; --warning:#f59e0b; --border:#1f2a44;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:"Segoe UI", system-ui, Tahoma, Arial; background:linear-gradient(120deg,#0b1020,#0f1c2e 60%,#0a1a25); color:var(--text)}
    header{padding:20px; border-bottom:1px solid var(--border); background:#091121a6; position:sticky; top:0; backdrop-filter:saturate(140%) blur(8px); z-index:3}
    h1{margin:0; font-size:22px}
    .container{max-width:1200px; margin:24px auto; padding:0 16px}
    .grid{display:grid; gap:16px}
    .grid-2{grid-template-columns:repeat(2,1fr)}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 10px 30px #00000033; transition:transform 0.2s, box-shadow 0.2s;}
    .card:hover{transform:translateY(-2px); box-shadow:0 12px 35px #00000055;}
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px 0}
    input, select, textarea{width:100%; background:#0f172a; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none; transition:border-color 0.2s}
    input:focus, select:focus, textarea:focus{border-color:var(--accent2)}
    textarea{resize:vertical; min-height:38px}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn{border:1px solid var(--border); background:#0f172a; color:var(--text); padding:9px 14px; border-radius:12px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:6px; transition:all 0.2s}
    .btn:hover{background:#1e293b}
    .btn.primary{background:linear-gradient(90deg,#22c55e,#16a34a); border:none}
    .btn.info{background:linear-gradient(90deg,#38bdf8,#06b6d4); border:none}
    .btn.warn{background:linear-gradient(90deg,#f59e0b,#f97316); border:none}
    .btn.danger{background:linear-gradient(90deg,#ef4444,#dc2626); border:none}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .table{width:100%; border-collapse:collapse; border:1px solid var(--border); border-radius:12px; overflow:auto}
    table{width:100%; border-collapse:collapse}
    thead th{position:sticky; top:0; background:#0b1424; border-bottom:1px solid var(--border); padding:10px; text-align:right; font-size:12px; color:#93c5fd}
    tbody td{border-bottom:1px solid var(--border); padding:8px; font-size:13px}
    tbody tr:hover{background:#0f172a55}
    .badge{display:inline-block; padding:3px 8px; border-radius:999px; background:#0b2540; color:#7dd3fc; border:1px solid #13325a; font-size:11px}
    .required{outline:1px dashed #ef4444; background:#2b0f12}
    .hint{font-size:12px; color:var(--muted)}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
    @media (max-width:920px){ .grid-2,.grid-3,.split{grid-template-columns:1fr} }
    .pill{border-radius:999px; padding:6px 10px; background:#0b1424; border:1px solid var(--border); color:#a3e635; font-size:12px}
    .footer{color:#9ca3af; font-size:12px; text-align:center; padding:16px}
    .mini{font-size:11px; color:#9ca3af}
    .mt8{margin-top:8px}
    #map{height:60vh; border-radius:16px; border:1px solid var(--border)}
    .legend{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .legend .item{display:flex; align-items:center; gap:6px; background:#0b1322; border:1px solid var(--border); padding:6px 10px; border-radius:999px}
    .swatch{width:14px; height:14px; border-radius:4px; border:1px solid #0006}
    .icon-btn{display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:8px; background:#1e293b; border:1px solid var(--border); cursor:pointer; transition:all 0.2s}
    .icon-btn:hover{background:#334155}
    .alert{position:fixed; top:20px; right:20px; padding:12px 16px; border-radius:8px; background:#0b1322; border:1px solid var(--border); box-shadow:0 4px 12px #00000055; z-index:1000; display:flex; align-items:center; gap:8px; transition:all 0.3s; transform:translateX(150%);} .alert.show{transform:translateX(0);} .alert.success{border-left:4px solid var(--accent);} .alert.error{border-left:4px solid var(--danger);} .alert.info{border-left:4px solid var(--accent2);}    

    /* شاشة الدخول */
    .auth-overlay{position:fixed; inset:0; background:linear-gradient(135deg,#0a1222,#07101a); display:flex; align-items:center; justify-content:center; z-index:999;}
    .auth-card{width:min(520px,94vw); background:#0b1220; border:1px solid var(--border); border-radius:20px; padding:22px; box-shadow:0 20px 60px #00000066}
    .auth-title{font-size:20px; margin-bottom:10px}

    /* ===== Marker styles (Font Awesome divIcon) ===== */
    .fa-marker{
      position:relative; display:inline-flex; align-items:center; justify-content:center;
      border-radius:50%; box-shadow:0 6px 16px #00000066;
      border:2px solid #fff; background:var(--m-bg,#0ea5e9);
      width:34px; height:34px; color:#fff; font-size:16px;
    }
    .fa-marker.bus{ background:var(--m-bg,#3b82f6); }
    .fa-marker.student{ background:var(--m-bg,#22c55e); }
    .fa-marker.observer{ background:var(--m-bg,#94a3b8); }
    .fa-marker.school{ background:var(--m-bg,#f59e0b); }
    .fa-marker .fa{ filter: drop-shadow(0 1px 1px #0008); }
    .fa-marker.pin::after{
      content:""; position:absolute; bottom:-6px; left:50%; transform:translateX(-50%);
      width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:8px solid #fff;
    }

    /* ===== منسقات نافذة البيانات (popup) ===== */
    .leaflet-popup-content-wrapper { background:#0b1220; color:#e5e7eb; border:1px solid #1f2a44; border-radius:14px; }
    .leaflet-popup-tip { background:#0b1220; }
    .map-popup { min-width: 240px; }
    .map-popup .title { font-weight:700; margin-bottom:6px; font-size:14px; }
    .map-popup .meta { font-size:12px; color:#93c5fd; margin-bottom:6px; }
    .map-popup .grid { display:grid; grid-template-columns: 1fr; gap:6px; font-size:13px; }
    .map-popup .row { display:flex; align-items:center; gap:8px; }
    .map-popup .key { color:#94a3b8; min-width:88px; }
    .map-popup .value { color:#e5e7eb; }
    .map-popup .actions { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .map-popup .btn-link { text-decoration:none; border:1px solid #1f2a44; padding:6px 10px; border-radius:999px; background:#0f172a; color:#e5e7eb; }
    .map-popup .btn-link:hover { background:#1e293b; }
  </style>
</head>
<body>
  <!-- AUTH OVERLAY -->
  <div id="auth" class="auth-overlay" style="display:none">
    <div class="auth-card">
      <div class="row" style="justify-content:space-between">
        <div class="auth-title"><i class="fas fa-right-to-bracket"></i> تسجيل الدخول / إنشاء حساب</div>
        <div class="mini" id="authStatus">غير مسجل الدخول</div>
      </div>
      <div class="grid grid-2 mt8">
        <div>
          <label>البريد الإلكتروني</label>
          <input id="authEmail" placeholder="name@example.com" type="email" />
        </div>
        <div>
          <label>كلمة المرور</label>
          <input id="authPassword" placeholder="••••••••" type="password" />
        </div>
      </div>
      <div class="row mt8">
        <button class="btn primary" id="btnLogin"><i class="fas fa-right-to-bracket"></i> دخول</button>
        <button class="btn info" id="btnRegister"><i class="fas fa-user-plus"></i> إنشاء حساب</button>
        <button class="btn" id="btnLogout" style="margin-inline-start:auto"><i class="fas fa-door-open"></i> تسجيل الخروج</button>
      </div>
      <div class="hint mt8">* بعد تسجيل الدخول سيتم تحميل بياناتك من Supabase.</div>
    </div>
  </div>

  <header>
    <div class="container row" style="justify-content:space-between">
      <div>
        <h1><i class="fas fa-bus"></i> نظام النقل المدرسي – إدارة الطلاب والباصات</h1>
        <div class="mini">يدعم روابط خرائط Google أو lat,lng ويعرض نقاط الطلاب + المدرسة + ملاحظي الباصات.</div>
      </div>
      <div class="row">
        <button class="btn info" id="btnExport"><i class="fas fa-file-export"></i> تصدير CSV</button>
        <button class="btn info" id="btnExportAll"><i class="fas fa-file-csv"></i> تصدير الكل</button>
        <label class="btn" for="fileImport"><i class="fas fa-file-import"></i> استيراد CSV</label>
        <input id="fileImport" type="file" accept=".csv" style="display:none" />
        <button class="btn" id="btnOpenAuth"><i class="fas fa-user"></i> الحساب</button>
      </div>
    </div>
  </header>

  <main class="container grid" style="gap:20px" id="app" hidden>
    <!-- إعداد المدرسة -->
    <section class="card">
      <div class="toolbar" style="justify-content:space-between">
        <div class="row" style="gap:12px">
          <span class="pill"><i class="fas fa-school"></i> إعداد المدرسة</span>
          <span class="hint">احفظ اسم المدرسة وموقعها لتظهر نقطة خاصة على الخريطة.</span>
        </div>
        <div class="row">
          <button class="btn primary" id="btnSaveSchool"><i class="fas fa-save"></i> حفظ إعداد المدرسة</button>
          <button class="btn" id="btnClearSchool"><i class="fas fa-eraser"></i> تفريغ</button>
        </div>
      </div>
      <div class="grid grid-3 mt8">
        <div>
          <label><i class="fas fa-school-flag"></i> اسم المدرسة *</label>
          <input id="schoolName" placeholder="مثال: مدرسة غرناطة الإعدادية للبنات" />
        </div>
        <div>
          <label><i class="fas fa-map-pin"></i> لوكيشن المدرسة (رابط أو lat,lng)</label>
          <input id="schoolLocAny" placeholder="25.286,51.533 أو رابط خرائط" />
          <div class="row mt8">
            <a id="schoolMapLink" class="btn" target="_blank" rel="noopener"><i class="fas fa-external-link-alt"></i> فتح في Google Maps</a>
          </div>
        </div>
        <div class="grid-2">
          <div>
            <label><i class="fas fa-map-marker-alt"></i> School Lat</label>
            <input id="schoolLat" placeholder="25.286" />
          </div>
          <div>
            <label><i class="fas fa-map-marker-alt"></i> School Lng</label>
            <input id="schoolLng" placeholder="51.533" />
          </div>
        </div>
      </div>
    </section>

    <!-- نموذج الطالب -->
    <section class="card">
      <div class="toolbar" style="justify-content:space-between">
        <div class="row" style="gap:12px">
          <span class="pill"><i class="fas fa-user-plus"></i> نموذج إدخال طالب</span>
          <span class="hint">الحقول بعلامة * مطلوبة</span>
        </div>
        <div class="row">
          <button class="btn warn" id="btnReset"><i class="fas fa-eraser"></i> تفريغ الحقول</button>
          <button class="btn primary" id="btnAdd"><i class="fas fa-save"></i> حفظ / إضافة</button>
        </div>
      </div>
      <div class="split mt8">
        <div>
          <div class="grid grid-3">
            <div>
              <label><i class="fas fa-user"></i> اسم الطالب *</label>
              <input id="studentName" placeholder="مثال: محمد علي" />
            </div>
            <div>
              <label><i class="fas fa-graduation-cap"></i> الصف</label>
              <input id="grade" placeholder="مثال: الخامس" />
            </div>
            <div>
              <label><i class="fas fa-users"></i> الشعبة</label>
              <input id="klass" placeholder="مثال: ب" />
            </div>

            <div class="grid-2">
              <div>
                <label><i class="fas fa-map-marker-alt"></i> Lat</label>
                <input id="lat" placeholder="25.286" />
              </div>
              <div>
                <label><i class="fas fa-map-marker-alt"></i> Lng</label>
                <input id="lng" placeholder="51.533" />
              </div>
            </div>
            <div>
              <label><i class="fas fa-map-pin"></i> لوكيشن (رابط أو lat,lng) – اختياري</label>
              <input id="locAny" placeholder="25.286,51.533 أو رابط خرائط" />
              <div class="row mt8">
                <a id="mapLink" class="btn" target="_blank" rel="noopener"><i class="fas fa-external-link-alt"></i> فتح في Google Maps</a>
                <button class="btn" id="copyMainMap"><i class="fas fa-copy"></i> نسخ الرابط</button>
              </div>
            </div>

            <div class="grid-2">
              <div>
                <label><i class="fas fa-user-shield"></i> اسم ولي الأمر *</label>
                <input id="guardianName" placeholder="اسم ولي الأمر" />
              </div>
              <div>
                <label><i class="fas fa-phone"></i> هاتف ولي الأمر *</label>
                <input id="guardianPhone" placeholder="05xxxxxxxx" />
              </div>
            </div>
            <div>
              <label><i class="fas fa-id-card"></i> الرقم الشخصي *</label>
              <input id="personalNo" placeholder="الرقم الشخصي" />
            </div>
            <div>
              <label><i class="fas fa-sticky-note"></i> ملاحظة الباص / نقطة النزول</label>
              <input id="busNote" placeholder="مثال: بوابة 2 – شارع 10" />
            </div>
          </div>
        </div>
        <div>
          <div class="card" style="background:#0a1322">
            <div class="row" style="justify-content:space-between; margin-bottom:8px">
              <div class="pill"><i class="fas fa-bus"></i> ربط برقم الباص</div>
              <a class="btn info" href="#bus-admin"><i class="fas fa-cog"></i> إدارة قائمة الباصات</a>
            </div>
            <div class="grid grid-2">
              <div>
                <label><i class="fas fa-bus"></i> رقم الباص *</label>
                <select id="busNo"></select>
              </div>
              <div>
                <label><i class="fas fa-info-circle"></i> الحالة</label>
                <select id="status">
                  <option value="Active">Active</option>
                  <option value="Withdrawn">Withdrawn</option>
                  <option value="Suspended">Suspended</option>
                </select>
              </div>
              <div>
                <label><i class="fas fa-user-tie"></i> اسم السائق (تلقائي)</label>
                <input id="driverName" disabled />
              </div>
              <div>
                <label><i class="fas fa-phone"></i> هاتف السائق (تلقائي)</label>
                <input id="driverPhone" disabled />
              </div>
              <div>
                <label><i class="fas fa-user-check"></i> اسم الملاحظ (تلقائي)</label>
                <input id="observerName" disabled />
              </div>
              <div>
                <label><i class="fas fa-phone"></i> هاتف الملاحظ (تلقائي)</label>
                <input id="observerPhone" disabled />
              </div>
            </div>
          </div>
          <div class="hint">اللصق في خانة "لوكيشن" يملأ الإحداثيات تلقائيًا إذا كانت Lat/Lng فارغة.</div>
        </div>
      </div>
    </section>

    <!-- جدول الطلاب -->
    <section class="card">
      <div class="toolbar" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <span class="pill"><i class="fas fa-table"></i> سجل الطلاب</span>
          <input id="q" placeholder="ابحث بالاسم/ولي الأمر/الهاتف/الرقم الشخصي/الباص/الموقع" style="min-width:320px" />
        </div>
        <div class="row">
          <button class="btn danger" id="btnClearAll"><i class="fas fa-trash"></i> مسح كل البيانات (من الحساب)</button>
        </div>
      </div>
      <div class="table mt8">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>اسم الطالب</th>
              <th>الموقع/الخريطة</th>
              <th>Lat</th>
              <th>Lng</th>
              <th>ولي الأمر</th>
              <th>هاتف</th>
              <th>الرقم الشخصي</th>
              <th>الباص</th>
              <th>سائق</th>
              <th>ملاحظ</th>
              <th>حالة</th>
              <th>ملاحظة</th>
              <th>تاريخ</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <!-- إدارة الباصات -->
    <section class="card" id="bus-admin">
      <div class="pill"><i class="fas fa-cogs"></i> إدارة الباصات</div>

      <!-- بطاقات -->
      <div class="grid grid-3 mt8" id="busManager"></div>

      <!-- نموذج إضافة/تعديل -->
      <div class="row mt8" style="flex-wrap:wrap; gap:8px">
        <input id="newBusNo" placeholder="رقم الباص *" />
        <input id="newPlate" placeholder="رقم اللوحة *" />
        <select id="newCapacity" style="min-width:120px">
          <option value="">حجم الباص *</option>
          <option>12</option><option>28</option><option>35</option><option>39</option>
        </select>
        <input id="newDriver" placeholder="اسم السائق" />
        <input id="newDriverPhone" placeholder="هاتف السائق" />
        <input id="newObserver" placeholder="اسم الملاحظ" />
        <input id="newObserverPhone" placeholder="هاتف الملاحظ" />
        <!-- لوكيشن الملاحظ -->
        <input id="newObserverLocAny" placeholder="لوكيشن الملاحظ (رابط أو lat,lng)" style="min-width:240px" />
        <input id="newObserverLat" placeholder="Obs Lat" style="max-width:120px" />
        <input id="newObserverLng" placeholder="Obs Lng" style="max-width:120px" />
        <div class="row" style="gap:8px">
          <button class="btn primary" id="addBus"><i class="fas fa-plus"></i> <span id="busSubmitLabel">إضافة باص</span></button>
          <button class="btn" id="cancelBusEdit" style="display:none"><i class="fas fa-times"></i> إلغاء التعديل</button>
        </div>
      </div>
      <div class="hint">اضغط "تعديل" على بطاقة الباص لتعبئة الحقول أعلاه ثم "تحديث باص".</div>
    </section>

    <!-- الخريطة -->
    <section class="card">
      <div class="toolbar" style="justify-content:space-between">
        <div class="row">
          <span class="pill"><i class="fas fa-map"></i> الخريطة التفاعلية</span>
          <select id="busFilter"><option value="">كل الباصات</option></select>
          <button class="btn info" id="btnExportBus"><i class="fas fa-file-export"></i> تصدير الباص المحدد</button>
          <button class="btn" id="fitAll"><i class="fas fa-expand"></i> إظهار جميع النقاط</button>
          <button class="btn" id="refreshMap"><i class="fas fa-sync-alt"></i> تحديث</button>
        </div>
        <div class="row"><span class="hint">تُعرض نقاط الطلاب (حسب الباص)، ونقطة المدرسة، ونقاط ملاحظي الباصات.</span></div>
      </div>
      <div id="map" class="mt8"></div>
      <div id="legend" class="legend"></div>
    </section>

    <section class="footer">© 2025 – البيانات تُحفظ في Supabase مع سياسات RLS.</section>
  </main>

  <!-- Alerts container -->
  <div id="alertContainer"></div>

  <script>
    // ===================== CONFIG =====================
    const SUPABASE_URL ="https://sxaegfyfmjoyvccpipiz.supabase.co"; // <-- عدّل
    const SUPABASE_ANON_KEY ="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4YWVnZnlmbWpveXZjY3BpcGl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMzIzMzUsImV4cCI6MjA3NjcwODMzNX0.IFw5sZXaXWVMEn1F5YXvu77FHHwIfG4GdFjTU49GMcw"; // <-- عدّل

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    // ===================== HELPERS =====================
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    function showAlert(message, type = 'info', duration = 4000) {
      const alertContainer = qs('#alertContainer');
      const alertId = 'alert-' + Date.now();
      const el = document.createElement('div');
      el.id = alertId; el.className = `alert ${type}`;
      const icon = type==='success'?'check-circle': type==='error'?'exclamation-circle':'info-circle';
      el.innerHTML = `<i class="fas fa-${icon}"></i><span>${message}</span><button class="icon-btn" onclick="document.getElementById('${alertId}').remove()"><i class="fas fa-times"></i></button>`;
      alertContainer.appendChild(el); setTimeout(()=>el.classList.add('show'),10);
      if(duration>0){ setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),300); }, duration); }
    }

    function parseAnyLocation(input){
      const s = (input||'').trim();
      if(!s) return {lat:'', lng:'', text:''};
      let m = s.match(/(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)/);
      if(m) return {lat:m[1], lng:m[2], text:`${m[1]},${m[2]}`};
      m = s.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
      if(m) return {lat:m[1], lng:m[2], text:`${m[1]},${m[2]}`};
      m = s.match(/[?&]q=([\-\d\.]+),([\-\d\.]+)/);
      if(m) return {lat:m[1], lng:m[2], text:`${m[1]},${m[2]}`};
      return {lat:'', lng:'', text:s};
    }
    function mapUrlFrom(loc){ const p = parseAnyLocation(loc); return (p.lat && p.lng) ? `https://maps.google.com/?q=${encodeURIComponent(p.lat)},${encodeURIComponent(p.lng)}` : (loc || '#'); }
    const PALETTE = ['#10b981','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#14b8a6','#22c55e','#eab308','#f97316','#06b6d4','#84cc16','#a855f7','#ec4899','#0ea5e9','#f43f5e'];
    function hashStr(str){ let h=0; for(let i=0;i<str.length;i++){ h=(h<<5)-h + str.charCodeAt(i); h|=0; } return Math.abs(h); }
    function busColor(busNo){ return busNo ? PALETTE[hashStr(busNo)%PALETTE.length] : '#9ca3af'; }

    // ===== أيقونات ونوافذ منسّقة (FA + divIcon) =====
    function createFAIcon({ type='student', fa='fa-user-graduate', bg, size=34 }) {
      const classMap = { student:'student', observer:'observer', school:'school', bus:'bus' };
      const className = `fa-marker pin ${classMap[type]||'student'}`;
      const html = `<div class="${className}" style="${bg?`--m-bg:${bg};`:''} width:${size}px; height:${size}px">
                      <i class="fa ${fa}"></i>
                    </div>`;
      return L.divIcon({
        className: '',
        html, iconSize: [size, size+6], iconAnchor: [size/2, size/2+6], popupAnchor: [0, -size/2]
      });
    }
    function popupBtn(href, label, icon='fa-external-link-alt'){
      return `<a class="btn-link" target="_blank" rel="noopener" href="${href}">
                <i class="fa ${icon}"></i> ${label}
              </a>`;
    }
    function mapLink(lat, lng){
      return `https://maps.google.com/?q=${encodeURIComponent(lat)},${encodeURIComponent(lng)}`;
    }

    // ===================== AUTH =====================
    const authOverlay = qs('#auth');
    const appMain = qs('#app');
    const authStatus = qs('#authStatus');
    async function requireAuth(){
      const { data:{ session } } = await supabase.auth.getSession();
      if(session){ authStatus.textContent = `مسجل: ${session.user.email}`; authOverlay.style.display='none'; appMain.hidden=false; return session; }
      authOverlay.style.display='flex'; appMain.hidden=true; return null;
    }
    qs('#btnOpenAuth').addEventListener('click', ()=>{ authOverlay.style.display='flex'; });
    qs('#btnLogin').addEventListener('click', async ()=>{
      const email = qs('#authEmail').value.trim();
      const password = qs('#authPassword').value.trim();
      if(!email||!password) return showAlert('أدخل البريد وكلمة المرور', 'error');
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error){ showAlert('فشل تسجيل الدخول: '+error.message, 'error'); return; }
      showAlert('تم تسجيل الدخول', 'success'); await bootstrap();
    });
    qs('#btnRegister').addEventListener('click', async ()=>{
      const email = qs('#authEmail').value.trim();
      const password = qs('#authPassword').value.trim();
      if(!email||!password) return showAlert('أدخل البريد وكلمة المرور', 'error');
      const { error } = await supabase.auth.signUp({ email, password });
      if(error){ showAlert('فشل إنشاء الحساب: '+error.message, 'error'); return; }
      showAlert('تم إنشاء الحساب. تحقق من بريدك إذا طُلب تأكيد.', 'success');
    });
    qs('#btnLogout').addEventListener('click', async ()=>{ await supabase.auth.signOut(); showAlert('تم تسجيل الخروج', 'success'); authOverlay.style.display='flex'; appMain.hidden=true; });

    // ===================== DATA ACCESS =====================
    async function sbUser(){ const { data:{ session } } = await supabase.auth.getSession(); return session?.user || null; }

    // buses
    async function sbSelectBuses(){
      const user = await sbUser(); if(!user) return [];
      const { data, error } = await supabase.from('buses').select('*').eq('profile_id', user.id).order('bus_no', { ascending:true });
      if(error){ showAlert('خطأ تحميل الباصات: '+error.message, 'error'); return []; }
      return data||[];
    }
    async function sbInsertBus(bus){
      const user = await sbUser(); if(!user) return;
      const payload = { ...bus, profile_id: user.id };
      const { error } = await supabase.from('buses').insert(payload);
      if(error) throw error;
    }
    async function sbUpdateBus(id,patch){
      const { error } = await supabase.from('buses').update(patch).eq('id', id);
      if(error) throw error;
    }
    async function sbDeleteBus(id){
      const { error } = await supabase.from('buses').delete().eq('id', id);
      if(error) throw error;
    }

    // students
    async function sbSelectStudents(){
      const user = await sbUser(); if(!user) return [];
      const { data, error } = await supabase.from('students').select('*').eq('profile_id', user.id).order('created_at', { ascending:true });
      if(error){ showAlert('خطأ تحميل الطلاب: '+error.message, 'error'); return []; }
      return data||[];
    }
    async function sbInsertStudent(stu){
      const user = await sbUser(); if(!user) return;
      const payload = { ...stu, profile_id: user.id };
      const { error } = await supabase.from('students').insert(payload);
      if(error) throw error;
    }
    async function sbUpdateStudent(id,patch){
      const { error } = await supabase.from('students').update(patch).eq('id', id);
      if(error) throw error;
    }
    async function sbDeleteStudent(id){
      const { error } = await supabase.from('students').delete().eq('id', id);
      if(error) throw error;
    }
    async function sbDeleteAll(){
      const user = await sbUser(); if(!user) return;
      await supabase.from('students').delete().eq('profile_id', user.id);
    }

    // school_settings
    async function sbGetSchool(){
      const user = await sbUser(); if(!user) return null;
      const { data, error } = await supabase.from('school_settings').select('*').eq('profile_id', user.id).single();
      if(error && error.code!=='PGRST116'){ showAlert('خطأ تحميل إعداد المدرسة: '+error.message, 'error'); return null; }
      return data||null;
    }
    async function sbUpsertSchool(obj){
      const user = await sbUser(); if(!user) return;
      const { data, error } = await supabase.from('school_settings').upsert(
        [{...obj, profile_id: user.id}],
        { onConflict: 'profile_id' }
      ).select().single();
      if(error) throw error;
      return data;
    }

    // ===================== STATE =====================
    let state = { buses: [], students: [], editingStudentId: null, editingBusId: null, school: null };

    // ===================== UI HELPERS =====================
    function updateLinkPreview(inputSel, latSel, lngSel, aSel){
      const lat = qs(latSel).value.trim();
      const lng = qs(lngSel).value.trim();
      const any = qs(inputSel).value.trim();
      const a = qs(aSel);
      let url = '#';
      if(lat && lng){ url = `https://maps.google.com/?q=${encodeURIComponent(lat)},${encodeURIComponent(lng)}`; }
      else if(any){ url = mapUrlFrom(any); }
      a.href = url; a.textContent = (url==='#') ? '—' : 'فتح في Google Maps';
    }
    function hydrateLatLngFromAny(inputSel, latSel, lngSel){
      const any = qs(inputSel).value.trim();
      const p = parseAnyLocation(any);
      const latEl = qs(latSel), lngEl = qs(lngSel);
      if(p.lat && p.lng){ if(!latEl.value) latEl.value = p.lat; if(!lngEl.value) lngEl.value = p.lng; }
    }

    // ===================== RENDERERS =====================
    function renderBusOptions(){
      const sel = qs('#busNo');
      const current = sel.value;
      sel.innerHTML = '<option value="">— اختر —</option>' + state.buses.map(b=>`<option value="${b.bus_no}">${b.bus_no}</option>`).join('');
      if(state.buses.some(b=>b.bus_no===current)) sel.value = current;
      updateBusAuto();
    }
    function getBus(busNo){ return state.buses.find(b=>b.bus_no===busNo); }
    function updateBusAuto(){
      const bus = getBus(qs('#busNo').value);
      qs('#driverName').value   = bus ? (bus.driver_name||'')   : '';
      qs('#driverPhone').value  = bus ? (bus.driver_phone||'')  : '';
      qs('#observerName').value = bus ? (bus.observer_name||'') : '';
      qs('#observerPhone').value= bus ? (bus.observer_phone||''): '';
    }

    function renderBusManager(){
      const host = qs('#busManager'); host.innerHTML='';
      state.buses.forEach((b)=>{
        const d=document.createElement('div'); d.className='card';
        d.innerHTML=`
          <div class="row" style="justify-content:space-between; gap:6px">
            <strong><i class="fas fa-bus"></i> ${b.bus_no}</strong>
            <div class="row" style="gap:6px">
              <button class="btn info" data-bedit="${b.id}"><i class="fas fa-edit"></i> تعديل</button>
              <button class="btn danger" data-bdel="${b.id}"><i class="fas fa-trash"></i> حذف</button>
            </div>
          </div>
          <div class="mini"><i class="fas fa-car"></i> لوحة: ${b.plate_no||'-'} • الحجم: ${b.capacity||'-'}</div>
          <div class="mini"><i class="fas fa-user-tie"></i> سائق: ${b.driver_name||'-'} – ${b.driver_phone||'-'}</div>
          <div class="mini"><i class="fas fa-user-check"></i> ملاحظ: ${b.observer_name||'-'} – ${b.observer_phone||'-'}</div>
          <div class="mini"><i class="fas fa-map-marker-alt"></i> لوكيشن الملاحظ: ${b.observer_location_text || (b.observer_lat&&b.observer_lng? (b.observer_lat+','+b.observer_lng): '-')}</div>
        `;
        host.appendChild(d);
      });
    }
    function renderBusFilter(){
      const sel = qs('#busFilter'); const cur = sel.value;
      sel.innerHTML = '<option value="">كل الباصات</option>' + state.buses.map(b=>`<option value="${b.bus_no}">${b.bus_no}</option>`).join('');
      if(cur && state.buses.some(b=>b.bus_no===cur)) sel.value = cur;
    }

    function renderLegend(){
      const legend = qs('#legend'); legend.innerHTML='';
      const inUse = new Set(state.students.map(s=>s.bus_no).filter(Boolean));
      state.buses.filter(b=>inUse.has(b.bus_no)).forEach(b=>{
        const div = document.createElement('div'); div.className='item';
        const color = busColor(b.bus_no);
        div.innerHTML = `<span class="swatch" style="background:${color}"></span> <span>${b.bus_no}</span>`;
        legend.appendChild(div);
      });
      if(state.school){ 
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `<span class="swatch" style="background:#f59e0b"></span> <span>المدرسة</span>`;
        legend.appendChild(div);
      }
      if(state.buses.some(b=> (b.observer_lat && b.observer_lng) || b.observer_location_text )){
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `<span class="swatch" style="background:#94a3b8"></span> <span>ملاحظو الباصات</span>`;
        legend.appendChild(div);
      }
    }

    // جدول الطلاب
    function renderRows(){
      const body = qs('#rows'); body.innerHTML = '';
      const q = (qs('#q').value||'').trim().toLowerCase();
      const filtered = state.students.filter(r=>{
        const blob = `${r.student_name} ${r.guardian_name||''} ${r.guardian_phone||''} ${r.personal_number||''} ${r.bus_no||''} ${r.location_text||''}`.toLowerCase();
        return blob.includes(q);
      });
      filtered.forEach((r, idx)=>{
        const mapHref = (r.location_lat && r.location_lng)
          ? `https://maps.google.com/?q=${encodeURIComponent(r.location_lat)},${encodeURIComponent(r.location_lng)}`
          : mapUrlFrom(r.location_text||'');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${r.student_name}</td>
          <td><a class="btn" target="_blank" rel="noopener" href="${mapHref}"><i class="fas fa-map-marked-alt"></i> خريطة</a><div class="mini">${r.location_text||''}</div></td>
          <td>${r.location_lat||''}</td>
          <td>${r.location_lng||''}</td>
          <td>${r.guardian_name||''}</td>
          <td>${r.guardian_phone||''}</td>
          <td>${r.personal_number||''}</td>
          <td><span class="badge" style="background:${busColor(r.bus_no)}22; border:1px solid ${busColor(r.bus_no)}66">${r.bus_no||'-'}</span></td>
          <td>${r.driver_name||''}</td>
          <td>${r.observer_name||''}</td>
          <td>${r.status||''}</td>
          <td>${r.bus_note||''}</td>
          <td>${(r.date_added||'').slice(0,10)}</td>
          <td class="row">
            <button class="btn info" data-edit="${r.id}"><i class="fas fa-edit"></i> تعديل</button>
            <button class="btn danger" data-del="${r.id}"><i class="fas fa-trash"></i> حذف</button>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    // الخريطة
    let map, markersLayer, observersLayer, schoolLayer;
    function ensureMap(){
      if(map) return;
      map = L.map('map', { zoomControl: true, attributionControl:false, minZoom: 2 });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      observersLayer = L.layerGroup().addTo(map);
      schoolLayer = L.layerGroup().addTo(map);
      map.setView([25.285, 51.531], 10);
    }
    function clearMapLayers(){ markersLayer.clearLayers(); observersLayer.clearLayers(); schoolLayer.clearLayers(); }

    // === Marker: Student (FA divIcon + popup منسّق) ===
    function addStudentMarker(stu){
      const p = parseAnyLocation(stu.location_text);
      const lat = parseFloat(stu.location_lat || p.lat);
      const lng = parseFloat(stu.location_lng || p.lng);
      if(Number.isNaN(lat) || Number.isNaN(lng)) return;

      const color = busColor(stu.bus_no);
      const icon = createFAIcon({ type:'student', fa:'fa-user-graduate', bg: color });

      const m = L.marker([lat,lng], { icon });

      const content = `
        <div class="map-popup">
          <div class="title"><i class="fa fa-user-graduate"></i> ${stu.student_name||'—'}</div>
          <div class="meta">باص: <strong>${stu.bus_no||'-'}</strong></div>
          <div class="grid">
            <div class="row"><span class="key"><i class="fa fa-user-shield"></i> ولي الأمر</span><span class="value">${stu.guardian_name||'-'}</span></div>
            <div class="row"><span class="key"><i class="fa fa-phone"></i> هاتف</span><span class="value">${stu.guardian_phone||'-'}</span></div>
            <div class="row"><span class="key"><i class="fa fa-id-card"></i> الرقم الشخصي</span><span class="value">${stu.personal_number||'-'}</span></div>
            <div class="row"><span class="key"><i class="fa fa-sticky-note"></i> ملاحظة</span><span class="value">${stu.bus_note||'-'}</span></div>
          </div>
          <div class="actions">
            ${popupBtn(mapLink(lat,lng), 'فتح في الخرائط')}
          </div>
        </div>`;
      m.bindTooltip(`${stu.student_name} — باص ${stu.bus_no||'-'}`, {direction:'top', offset:[0,-10]});
      m.bindPopup(content);
      markersLayer.addLayer(m);
      return [lat,lng];
    }

    // === Marker: Observer (FA divIcon + popup) ===
    function addObserverMarker(bus){
      let lat = parseFloat(bus.observer_lat);
      let lng = parseFloat(bus.observer_lng);
      if((Number.isNaN(lat) || Number.isNaN(lng)) && bus.observer_location_text){
        const p = parseAnyLocation(bus.observer_location_text);
        lat = parseFloat(p.lat); lng = parseFloat(p.lng);
      }
      if(Number.isNaN(lat) || Number.isNaN(lng)) return;

      const icon = createFAIcon({ type:'observer', fa:'fa-user-shield', bg:'#94a3b8' });
      const m = L.marker([lat,lng], { icon });

      const content = `
        <div class="map-popup">
          <div class="title"><i class="fa fa-user-shield"></i> ${bus.observer_name||'ملاحظ باص'}</div>
          <div class="meta">باص: <strong>${bus.bus_no||'-'}</strong></div>
          <div class="grid">
            <div class="row"><span class="key"><i class="fa fa-phone"></i> هاتف</span><span class="value">${bus.observer_phone||'-'}</span></div>
            <div class="row"><span class="key"><i class="fa fa-user-tie"></i> السائق</span><span class="value">${bus.driver_name||'-'} ${bus.driver_phone?('— '+bus.driver_phone):''}</span></div>
            <div class="row"><span class="key"><i class="fa fa-car"></i> اللوحة</span><span class="value">${bus.plate_no||'-'}</span></div>
            <div class="row"><span class="key"><i class="fa fa-users"></i> السعة</span><span class="value">${bus.capacity||'-'}</span></div>
          </div>
          <div class="actions">
            ${popupBtn(mapLink(lat,lng), 'فتح في الخرائط')}
          </div>
        </div>`;
      m.bindTooltip(`ملاحظ: ${bus.observer_name||'-'} — باص ${bus.bus_no||'-'}`, {direction:'top', offset:[0,-10]});
      m.bindPopup(content);
      observersLayer.addLayer(m);
      return [lat,lng];
    }

    // === Marker: School (FA divIcon + popup) ===
    function addSchoolMarker(){
      if(!state.school) return null;
      const lat = parseFloat(state.school.school_lat);
      const lng = parseFloat(state.school.school_lng);
      if(Number.isNaN(lat) || Number.isNaN(lng)) return null;

      const icon = createFAIcon({ type:'school', fa:'fa-school', bg:'#f59e0b' });
      const m = L.marker([lat,lng], { icon });

      const content = `
        <div class="map-popup">
          <div class="title"><i class="fa fa-school"></i> ${state.school.school_name||'المدرسة'}</div>
          <div class="grid">
            <div class="row"><span class="key"><i class="fa fa-location-dot"></i> الإحداثيات</span><span class="value">${lat.toFixed(6)}, ${lng.toFixed(6)}</span></div>
            ${state.school.school_location_text ? `<div class="row"><span class="key"><i class="fa fa-map-pin"></i> المصدر</span><span class="value">${state.school.school_location_text}</span></div>` : ''}
          </div>
          <div class="actions">
            ${popupBtn(mapLink(lat,lng), 'فتح في الخرائط')}
          </div>
        </div>`;
      m.bindTooltip(`🏫 ${state.school.school_name||'المدرسة'}`, {direction:'top', offset:[0,-10]});
      m.bindPopup(content);
      schoolLayer.addLayer(m);
      return [lat,lng];
    }

    function renderMap(){
      ensureMap(); clearMapLayers();
      const sel = qs('#busFilter'); const filter = sel ? sel.value : '';
      const pts = [];

      // الطلاب
      const toShow = state.students.filter(s=>{
        const p = parseAnyLocation(s.location_text);
        const hasPoint = (s.location_lat && s.location_lng) || (p.lat && p.lng);
        return hasPoint && (!filter || s.bus_no === filter);
      });
      toShow.forEach(s=>{ const p = addStudentMarker(s); if(p) pts.push(p); });

      // المدرسة
      const schPt = addSchoolMarker(); if(schPt) pts.push(schPt);

      // ملاحظو الباصات
      state.buses
        .filter(b=>!filter || b.bus_no===filter)
        .forEach(b=>{ const p = addObserverMarker(b); if(p) pts.push(p); });

      renderLegend(); renderBusFilter();

      if(pts.length){ const bounds = L.latLngBounds(pts); map.fitBounds(bounds.pad(0.2)); } else { map.setView([25.285, 51.531], 10); }
    }

    // ===================== STUDENT FORM =====================
    function requiredCheck(el){ if(!el) return false; const ok = !!el.value.trim(); el.classList.toggle('required', !ok); return ok; }
    function validateStudent(){
      const reqs = ['#studentName','#guardianName','#guardianPhone','#personalNo','#busNo'];
      const latOk = !!qs('#lat').value.trim();
      const lngOk = !!qs('#lng').value.trim();
      const anyParsed = parseAnyLocation(qs('#locAny').value);
      const anyOk = !!anyParsed.lat && !!anyParsed.lng;
      const basic = reqs.map(s=>requiredCheck(qs(s))).every(Boolean);
      if(!( (latOk && lngOk) || anyOk )){ qs('#locAny').classList.add('required'); return false; }
      qs('#locAny').classList.remove('required');
      return basic;
    }
    function getStudentForm(){
      let lat = qs('#lat').value.trim();
      let lng = qs('#lng').value.trim();
      if(!lat || !lng){ const p = parseAnyLocation(qs('#locAny').value); lat = lat||p.lat; lng = lng||p.lng; }
      return {
        student_name: qs('#studentName').value.trim(),
        grade: qs('#grade').value.trim(),
        class: qs('#klass').value.trim(),
        location_text: qs('#locAny').value.trim(),
        location_lat: lat || null,
        location_lng: lng || null,
        guardian_name: qs('#guardianName').value.trim(),
        guardian_phone: qs('#guardianPhone').value.trim(),
        personal_number: qs('#personalNo').value.trim(),
        bus_no: qs('#busNo').value,
        bus_note: qs('#busNote').value.trim(),
        driver_name: qs('#driverName').value,
        driver_phone: qs('#driverPhone').value,
        observer_name: qs('#observerName').value,
        observer_phone: qs('#observerPhone').value,
        status: qs('#status').value,
        date_added: new Date().toISOString().slice(0,10),
      }
    }
    function setStudentForm(o){
      qs('#studentName').value = o.student_name||'';
      qs('#grade').value = o.grade||'';
      qs('#klass').value = o.class||'';
      qs('#lat').value = o.location_lat||'';
      qs('#lng').value = o.location_lng||'';
      qs('#locAny').value = o.location_text || '';
      qs('#guardianName').value = o.guardian_name||'';
      qs('#guardianPhone').value = o.guardian_phone||'';
      qs('#personalNo').value = o.personal_number||'';
      qs('#busNo').value = o.bus_no||''; updateBusAuto();
      qs('#busNote').value = o.bus_note||'';
      qs('#status').value = o.status||'Active';
      updateLinkPreview('#locAny','#lat','#lng','#mapLink');
    }
    function clearStudentForm(){ setStudentForm({}); state.editingStudentId=null; qsa('.required').forEach(e=>e.classList.remove('required')); }
    async function addOrUpdateStudent(){
      hydrateLatLngFromAny('#locAny','#lat','#lng');
      if(!validateStudent()) return showAlert('أكمل الحقول المطلوبة (*) أو أدخل لوكيشن صالح.', 'error');
      const obj = getStudentForm();
      try{
        if(!state.editingStudentId){ await sbInsertStudent(obj); showAlert('تم إضافة الطالب بنجاح', 'success'); }
        else { await sbUpdateStudent(state.editingStudentId, obj); showAlert('تم تحديث بيانات الطالب', 'success'); }
        clearStudentForm(); await reloadAll();
      }catch(e){ showAlert('خطأ في الحفظ: '+e.message, 'error'); }
    }

    // ===================== BUS FORM =====================
    function fillBusForm(b){
      qs('#newBusNo').value = b.bus_no||'';
      qs('#newPlate').value = b.plate_no||'';
      qs('#newCapacity').value = b.capacity||'';
      qs('#newDriver').value = b.driver_name||'';
      qs('#newDriverPhone').value = b.driver_phone||'';
      qs('#newObserver').value = b.observer_name||'';
      qs('#newObserverPhone').value = b.observer_phone||'';
      qs('#newObserverLocAny').value = b.observer_location_text||'';
      qs('#newObserverLat').value = b.observer_lat||'';
      qs('#newObserverLng').value = b.observer_lng||'';
      qs('#busSubmitLabel').textContent = 'تحديث باص';
      qs('#cancelBusEdit').style.display = '';
    }
    function clearBusForm(){
      ['#newBusNo','#newPlate','#newCapacity','#newDriver','#newDriverPhone','#newObserver','#newObserverPhone','#newObserverLocAny','#newObserverLat','#newObserverLng'].forEach(s=>qs(s).value='');
      state.editingBusId = null;
      qs('#busSubmitLabel').textContent = 'إضافة باص';
      qs('#cancelBusEdit').style.display = 'none';
    }
    function getBusForm(){
      let lat = qs('#newObserverLat').value.trim();
      let lng = qs('#newObserverLng').value.trim();
      if(!lat || !lng){
        const p = parseAnyLocation(qs('#newObserverLocAny').value);
        lat = lat||p.lat; lng = lng||p.lng;
      }
      return {
        bus_no: qs('#newBusNo').value.trim(),
        plate_no: qs('#newPlate').value.trim(),
        capacity: Number(qs('#newCapacity').value.trim()) || qs('#newCapacity').value.trim(),
        driver_name: qs('#newDriver').value.trim(),
        driver_phone: qs('#newDriverPhone').value.trim(),
        observer_name: qs('#newObserver').value.trim(),
        observer_phone: qs('#newObserverPhone').value.trim(),
        observer_location_text: qs('#newObserverLocAny').value.trim(),
        observer_lat: lat || null,
        observer_lng: lng || null
      }
    }

    // ===================== EVENTS =====================
    document.addEventListener('click', async (e)=>{
      const editId = e.target.getAttribute('data-edit');
      const delId  = e.target.getAttribute('data-del');
      const bedit  = e.target.getAttribute('data-bedit');
      const bdel   = e.target.getAttribute('data-bdel');

      if(editId){
        const row = state.students.find(r=>String(r.id)===String(editId));
        if(row){ state.editingStudentId = row.id; setStudentForm(row); window.scrollTo({top:0,behavior:'smooth'}); }
      }
      if(delId){
        if(confirm('تأكيد حذف السجل؟')){
          try{ await sbDeleteStudent(delId); await reloadAll(); showAlert('تم حذف الطالب', 'success'); }
          catch(e){ showAlert('خطأ الحذف: '+e.message, 'error'); }
        }
      }

      if(bedit){
        const b = state.buses.find(x=>String(x.id)===String(bedit)); if(!b) return;
        state.editingBusId = b.id; fillBusForm(b);
        showAlert('تم تحميل بيانات الباص للتعديل', 'info', 2500);
      }
      if(bdel){
        if(confirm('حذف الباص؟')){
          try{ await sbDeleteBus(bdel); await reloadAll(); showAlert('تم حذف الباص', 'success'); clearBusForm(); }
          catch(e){ showAlert('خطأ: '+e.message, 'error'); }
        }
      }
    });

    // أزرار الطالب
    qs('#btnAdd').addEventListener('click', addOrUpdateStudent);
    qs('#btnReset').addEventListener('click', clearStudentForm);
    qsa('#studentName,#lat,#lng,#guardianName,#guardianPhone,#personalNo').forEach(el=>{ el.addEventListener('input', ()=>{ requiredCheck(el); updateLinkPreview('#locAny','#lat','#lng','#mapLink'); }); });
    qs('#locAny').addEventListener('input', ()=>{ hydrateLatLngFromAny('#locAny','#lat','#lng'); updateLinkPreview('#locAny','#lat','#lng','#mapLink'); });
    qs('#busNo').addEventListener('change', ()=>{ updateBusAuto(); validateStudent(); });
    qs('#q').addEventListener('input', ()=>{ renderRows(); });

    // أزرار الباص
    qs('#addBus').addEventListener('click', async ()=>{
      const bus = getBusForm();
      if(!bus.bus_no) return showAlert('أدخل رقم الباص', 'error');
      if(!bus.plate_no) return showAlert('أدخل رقم اللوحة', 'error');
      if(!bus.capacity) return showAlert('اختر حجم الباص', 'error');
      try{
        if(!state.editingBusId){ await sbInsertBus(bus); showAlert('تم إضافة الباص', 'success'); }
        else { await sbUpdateBus(state.editingBusId, bus); showAlert('تم تحديث الباص', 'success'); }
        clearBusForm(); await reloadAll();
      }catch(e){ showAlert('خطأ: '+e.message, 'error'); }
    });
    qs('#cancelBusEdit').addEventListener('click', ()=>{ clearBusForm(); });

    // CSV
    const EXPORT_HEADERS = [
      {key:'student_name',     title:'اسم الطالب'},
      {key:'location_text',    title:'الموقع (نص)'},
      {key:'location_lat',     title:'Lat'},
      {key:'location_lng',     title:'Lng'},
      {key:'guardian_name',    title:'ولي الأمر'},
      {key:'guardian_phone',   title:'هاتف ولي الأمر'},
      {key:'personal_number',  title:'الرقم الشخصي'},
      {key:'bus_no',           title:'رقم الباص'},
      {key:'driver_name',      title:'اسم السائق'},
      {key:'observer_name',    title:'اسم الملاحظ'},
      {key:'status',           title:'الحالة'},
      {key:'bus_note',         title:'ملاحظة الباص'},
      {key:'date_added',       title:'تاريخ الإضافة'},
      {key:'_Map_Link',        title:'رابط الخريطة'}
    ];
    function buildMapLink(row){
      if(row.location_lat && row.location_lng){ return `https://maps.google.com/?q=${encodeURIComponent(row.location_lat)},${encodeURIComponent(row.location_lng)}`; }
      return mapUrlFrom(row.location_text||'');
    }
    function getFilteredStudents(){
      const q = (qs('#q')?.value||'').trim().toLowerCase();
      if(!q) return state.students;
      return state.students.filter(r=>{
        const blob = `${r.student_name} ${r.guardian_name||''} ${r.guardian_phone||''} ${r.personal_number||''} ${r.bus_no||''} ${r.location_text||''}`.toLowerCase();
        return blob.includes(q);
      });
    }
    function toCSVOrdered(arr){
      const header = EXPORT_HEADERS.map(h=>`"${h.title}"`).join(',');
      if(!arr.length){ return header + '\n'; }
      const lines = [header];
      arr.forEach(o=>{
        const row = {...o}; row._Map_Link = buildMapLink(row);
        const cols = EXPORT_HEADERS.map(h=> '"' + String(row[h.key] ?? '').replaceAll('"','""') + '"').join(',');
        lines.push(cols);
      });
      return lines.join('\n');
    }
    qs('#btnExport').addEventListener('click', ()=>{
      const data = getFilteredStudents(); if(!data.length) return showAlert('لا توجد بيانات للتصدير', 'error');
      const csv = toCSVOrdered(data); const BOM = '\uFEFF';
      const blob = new Blob([BOM, csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'students_export.csv'; a.click();
      showAlert('تم تصدير البيانات', 'success');
    });
    qs('#btnExportAll').addEventListener('click', ()=>{
      const data = state.students; if(!data.length) return showAlert('لا توجد بيانات للتصدير', 'error');
      const csv = toCSVOrdered(data); const BOM = '\uFEFF';
      const blob = new Blob([BOM, csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'students_export_all.csv'; a.click();
      showAlert('تم تصدير جميع البيانات', 'success');
    });
    qs('#btnExportBus').addEventListener('click', ()=>{
      const sel = qs('#busFilter'); const bus = sel.value.trim(); if(!bus) return showAlert('اختر رقم باص أولاً', 'error');
      const data = state.students.filter(s=>s.bus_no===bus); if(!data.length) return showAlert('لا توجد سجلات لهذا الباص', 'error');
      const csv = toCSVOrdered(data); const BOM='\uFEFF'; const blob=new Blob([BOM,csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = `students_bus_${bus}.csv`; a.click();
      showAlert(`تم تصدير بيانات الباص ${bus}`, 'success');
    });

    // استيراد CSV
    function fromCSV(text){
      const headerMap = {
        'اسم الطالب':'student_name', 'Student_Name':'student_name',
        'الموقع (نص)':'location_text', 'Location_Text':'location_text', 'الموقع/الخريطة':'location_text',
        'Lat':'location_lat', 'Location_Lat':'location_lat',
        'Lng':'location_lng', 'Location_Lng':'location_lng',
        'ولي الأمر':'guardian_name', 'Guardian_Name':'guardian_name',
        'هاتف ولي الأمر':'guardian_phone', 'هاتف':'guardian_phone', 'Guardian_Phone':'guardian_phone',
        'الرقم الشخصي':'personal_number', 'Personal_Number':'personal_number',
        'رقم الباص':'bus_no', 'الباص':'bus_no', 'Bus_No':'bus_no',
        'اسم السائق':'driver_name', 'سائق':'driver_name', 'Driver_Name':'driver_name',
        'اسم الملاحظ':'observer_name', 'ملاحظ':'observer_name', 'Observer_Name':'observer_name',
        'الحالة':'status', 'حالة':'status', 'Status':'status',
        'ملاحظة الباص':'bus_note', 'ملاحظة':'bus_note', 'Bus_Note':'bus_note',
        'تاريخ الإضافة':'date_added', 'تاريخ':'date_added', 'Date_Added':'date_added',
        'رابط الخريطة':'_Map_Link', '_Map_Link':'_Map_Link'
      };
      const lines = text.split(/\r?\n/).filter(l=>l.length>0);
      if(!lines.length) return [];
      const rawHeaders = lines.shift().split(',').map(h=>h.replace(/^\"|\"$/g,''));
      const keys = rawHeaders.map(h=> headerMap[h]?.toString() || h);
      const out = [];
      lines.forEach(line=>{
        const cols = []; let cur=''; let inQ=false;
        for(let i=0;i<line.length;i++){
          const ch=line[i];
          if(ch==='"'){
            if(inQ && line[i+1]==='"'){ cur+='"'; i++; }
            else{ inQ=!inQ; }
          } else if(ch===',' && !inQ){ cols.push(cur); cur=''; }
          else{ cur+=ch; }
        }
        cols.push(cur);
        const obj = {}; keys.forEach((k,idx)=>{ const val=(cols[idx]??'').replace(/^\"|\"$/g,''); if(k && k!=='_Map_Link') obj[k]=val; });
        if((!obj.location_lat || !obj.location_lng) && obj.location_text){ const p=parseAnyLocation(obj.location_text); if(p.lat&&p.lng){ obj.location_lat=obj.location_lat||p.lat; obj.location_lng=obj.location_lng||p.lng; } }
        out.push(obj);
      });
      return out;
    }
    qs('#fileImport').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      try{
        const text = await file.text();
        const rows = fromCSV(text);
        if(!rows.length) return showAlert('لا يوجد بيانات صالحة', 'error');
        for(const r of rows){ await sbInsertStudent(r); }
        await reloadAll(); showAlert(`تم استيراد ${rows.length} سجل`, 'success');
      }catch(err){ console.error(err); showAlert('فشل الاستيراد: '+err.message, 'error'); }
      e.target.value = '';
    });

    // المدرسة: حقول وأزرار
    qs('#schoolLocAny').addEventListener('input', ()=>{ hydrateLatLngFromAny('#schoolLocAny','#schoolLat','#schoolLng'); updateLinkPreview('#schoolLocAny','#schoolLat','#schoolLng','#schoolMapLink'); });
    qsa('#schoolName,#schoolLat,#schoolLng').forEach(el=> el.addEventListener('input', ()=> updateLinkPreview('#schoolLocAny','#schoolLat','#schoolLng','#schoolMapLink') ));
    qs('#btnSaveSchool').addEventListener('click', async ()=>{
      const name = qs('#schoolName').value.trim();
      let lat = qs('#schoolLat').value.trim();
      let lng = qs('#schoolLng').value.trim();
      if(!lat || !lng){ const p = parseAnyLocation(qs('#schoolLocAny').value); lat = lat||p.lat; lng = lng||p.lng; }
      if(!name || !lat || !lng){ return showAlert('يرجى إدخال اسم المدرسة وموقع صحيح', 'error'); }
      try{
        const payload = {
          school_name: name,
          school_lat: Number(lat),
          school_lng: Number(lng),
          school_location_text: qs('#schoolLocAny').value.trim()
        };
        state.school = await sbUpsertSchool(payload);
        showAlert('تم حفظ إعداد المدرسة', 'success'); renderMap();
      }catch(e){ showAlert('خطأ حفظ إعداد المدرسة: '+e.message, 'error'); }
    });
    qs('#btnClearSchool').addEventListener('click', ()=>{
      qs('#schoolName').value=''; qs('#schoolLocAny').value=''; qs('#schoolLat').value=''; qs('#schoolLng').value='';
      updateLinkPreview('#schoolLocAny','#schoolLat','#schoolLng','#schoolMapLink');
    });

    // BOOTSTRAP
    qs('#fitAll').addEventListener('click', renderMap);
    qs('#refreshMap').addEventListener('click', reloadAll);
    qs('#busFilter').addEventListener('change', renderMap);

    async function reloadAll(){
      state.buses = await sbSelectBuses();
      renderBusOptions(); renderBusManager(); renderBusFilter();

      state.students = await sbSelectStudents();
      renderRows();

      state.school = await sbGetSchool();
      renderLegend(); renderMap();
    }
    async function bootstrap(){ const session = await requireAuth(); if(!session) return; await reloadAll(); }
    (async ()=>{ await bootstrap(); })();
  </script>
</body>
</html>
